<project name="checkstyle" default="checkstyle">
  <description>
  Runs checkstyle on system, using rules in: lib/checkstyle/checkstyle.modules.xml
  Invocation: ant -f checkstyle.build.xml
  </description>

  <import file="build.xml"/>
  <property name="checkstyle.version" value="4.3" />
  <property name="checkstyle.dir" location="${build.dir}/checkstyle"/>
  <property name="checkstyle.jar" value="checkstyle-all-${checkstyle.version}.jar"/>
  <property name="checkstyle.failOnViolation" value="false"/>

  <path id="checkstyle.classpath">
    <pathelement path="${build.dir}/classes"/>
    <path refid="compile.classpath"/>
  </path>

  <target name="checkstyle" depends="checkstyle.tool, checkstyle.sensor" 
      description="Runs Checkstyle and the Checkstyle sensor."/>

  <target name="checkstyle.tool" description="Checks the style of the sources and reports issues.">
    <!-- Check for the CHECKSTYLE_HOME environment variable; fail build if it can't be found. -->
    <available file="${env.CHECKSTYLE_HOME}/${checkstyle.jar}" property="checkstyle.available"/>
    <fail unless="checkstyle.available" 
        message="Error: CHECKSTYLE_HOME not set or ${env.CHECKSTYLE_HOME}/${checkstyle.jar} not found."/>
    <taskdef resource="checkstyletask.properties" classpath="${env.CHECKSTYLE_HOME}/${checkstyle.jar}" />

    <mkdir dir="${checkstyle.dir}"/>
    <checkstyle config="${lib.dir}/checkstyle/checkstyle.modules.xml"
                failOnViolation="${checkstyle.failOnViolation}" 
                classpathref="checkstyle.classpath">
      <fileset dir="${src.dir}" includes="**/*.java" />
      <formatter type="plain"/>
      <formatter type="xml" tofile="${checkstyle.dir}/checkstyle.xml" />
    </checkstyle>
  </target>
	
	<target name="checkstyle.sensor" unless="checkstyle.disabled" description="Sends CodeIssue data to Hackystat using the Checkstyle Sensor.">
	  <available file="${env.HACKYSTAT_ANTSENSORS_HOME}/antsensors.jar" type="file" property="hackystat.antsensors.available"/>
	  <fail message="${env.HACKYSTAT_ANTSENSORS_HOME}/antsensors.jar could not be found." unless="hackystat.antsensors.available"/>   
	  <taskdef resource="antlib.xml" classpath="${env.HACKYSTAT_ANTSENSORS_HOME}/antsensors.jar"/>
	    
	  <!-- Send Checkstyle data to hackystat using the Checkstyle sensor. -->
	  <hacky-checkstyle verbose="${hackystat.verbose.mode}">
	    <fileset file="${checkstyle.dir}/checkstyle.xml"/>
	  </hacky-checkstyle>
	</target>

</project>


