<project name="pmd" default="pmd">
  <description>
    Runs pmd on system, using rules in: lib/pmd/pmd.rulesets.xml
    Invocation: ant -f pmd.build.xml
  </description>

  <property environment="env" />
  <import file="build.xml" />
  <property name="pmd.version" value="4.2.3" />
  <property name="pmd.jar" value="pmd-${pmd.version}.jar" />
  <property name="pmd.dir" location="${build.dir}/pmd" />
  <property name="pmd.failonerror" value="false" />

  <target name="pmd" depends="pmd.tool, pmd.report, pmd.sensor" description="Runs the PMD tool, report, and sensor." />

  <target name="pmd.tool" depends="compile" description="Runs PMD over the source code to check for problems.">
    <!-- Fail this target if PMD is not installed. -->
    <available file="${env.PMD_HOME}/lib/${pmd.jar}" property="pmd.available" />
    <fail unless="pmd.available" message="Error: PMD_HOME not set or ${pmd.jar} not found." />
    <taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask">
      <classpath>
        <fileset dir="${env.PMD_HOME}/lib" includes="*.jar" />
      </classpath>
    </taskdef>

    <!-- Run PMD -->
    <mkdir dir="${pmd.dir}" />
    <pmd rulesetfiles="${basedir}/lib/pmd/pmd.rulesets.xml" shortFilenames="true" targetjdk="1.5" failuresPropertyName="pmd.failure.count" failonerror="${pmd.failonerror}" failOnRuleViolation="${pmd.failonerror}">
      <formatter type="xml" toFile="${pmd.dir}/pmd.xml" />
      <fileset dir="${src.dir}" includes="**/*.java" />
    </pmd>
    <echo message="PMD found ${pmd.failure.count} problem(s)." />
  </target>

  <target name="pmd.report" description="Generates HTML reports on the PMD output.">
    <xslt in="${pmd.dir}/pmd.xml" style="${env.PMD_HOME}/etc/xslt/pmd-report-per-class.xslt" out="${pmd.dir}/pmd-report-per-class.html" />
  </target>

  <target name="pmd.sensor" description="Sends CodeIssue data to Hackystat using the PMD sensor.">
    <available file="${env.HACKYSTAT_ANTSENSORS_HOME}/antsensors.jar" type="file" property="hackystat.antsensors.available" />
    <fail message="${env.HACKYSTAT_ANTSENSORS_HOME}/antsensors.jar could not be found." unless="hackystat.antsensors.available" />
    <taskdef resource="antlib.xml" classpath="${env.HACKYSTAT_ANTSENSORS_HOME}/antsensors.jar" />

    <hacky-pmd verbose="${hackystat.verbose.mode}" retryAttempts="3" retryWaitInterval="5">
      <datafiles>
        <fileset file="${pmd.dir}/pmd.xml" />
      </datafiles>
      <sourcefiles>
        <fileset dir="${src.dir}" includes="**/*.java" excludes="**/jaxb/**" />
      </sourcefiles>
    </hacky-pmd>
  </target>
</project>

